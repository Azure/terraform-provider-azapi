---
name: update-locations

on:
  schedule:
    - cron: '15 4 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Azure CLI login
        run: az login --output none --username="${{ secrets.AZCLI_USERNAME }}" --password="${{ secrets.AZCLI_PASSWORD }}"

      - name: install jd
        run: |
          go install github.com/josephburnett/jd@v1.7.1

      - name: checkout branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout -b update${{ github.run_id }}

      - name: update locations data
        run: |
          az rest --method GET --uri /locations?api-version=2023-07-01 | jq '{ "locals": { "locations_cached": {"value": .value }}}' > locations.tf.json
        working-directory: ${{ github.workspace }}

      - name: update compute provider data
        run: |
          az rest --method GET --uri /subscriptions/${{ secrets.ARM_SUBSCRIPTION_ID }}/providers/Microsoft.Compute?api-version=2022-12-01 | jq '{ "locals": { "regions_zonemappings_cached": {"resourceTypes": .resourceTypes }}}' > microsoft.compute_resourceTypes.tf.json
        working-directory: ${{ github.workspace }}

      - name: commit changes & create PR
        id: pr
        if: env.UPDATED == '1'
        run: |
          if [[ -n $(git status -suno) ]]; then
            git commit -m "feat: update data from Azure"
            git push origin update${{ github.run_id }}
            PR_URL=$(gh pr create --title "feat: update data from Azure" --body "Updated from GH run id: ${{ github.run_id }}" --base main --head update${{ github.run_id }})
            echo pull-request-number=$(gh pr view $PR_URL --json number | jq -r '.number') >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: close and comment out of date prs
        if: env.UPDATED == '1'
        run: |
          PULL_REQUESTS=$(gh pr list --search "feat: update data from Azure" --json number,headRefName)
          echo "$PULL_REQUESTS" | jq -r '.[] | select(.number != ${{ steps.pr.outputs.pull-request-number }}) | .number' | xargs -I {} gh pr close {} --delete-branch --comment "Supersceeded by #${{ steps.pr.outputs.pull-request-number }}"
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
